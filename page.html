<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Warp Core</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #c {
        position: absolute;
        left: 0;
        top: 0;
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
      }

      #fps-counter {
        position: absolute;
        top: 0px;
        right: 0px;
        width: 60px;
        height: 16px;
        font-size: 16px;
        color: white;
      }
    </style>
  </head>
  <body>
    <canvas id="c" tabindex="0"></canvas>
    <div id='fps-counter'> .... fps </div>
  </body>

  <script>

var Module = {
    onRuntimeInitialized: () => {
      let frames = 0
      let frameTime = new Date().getTime()
      let refreshPointer = false

      const canvas = document.getElementById('c');
      const mod = Module['asm']
      const memory = wasmMemory

      let height = canvas.height;
      let width = canvas.width;
      // Disabling alpha seems to give a slight boost. Image data still includes alpha though.
      const ctx = canvas.getContext(
        '2d',
        {
          alpha: false,
          antialias: false,
          depth: false
        }
      );
      if (!ctx) {
        throw 'Your browser does not support canvas';
      }

      const onResize = () => {
        width = Math.floor(window.innerWidth)
        height = Math.floor(window.innerHeight)
        mod._updateCanvas(width, height);
        refreshPointer = true
        canvas.width = width
        canvas.height = height
      }

      // initialize routines
      mod._initInput()

      canvas.onkeydown    = function (e) {
        mod._processKey(e.keyCode, 1)
      }
      canvas.onkeyup      = function (e) {
        mod._processKey(e.keyCode, 0)
      }
      onResize()
      window.onresize = onResize

      let pointer
      let data
      let img

      const render = (timestamp) => {
          const np = mod._render(timestamp);
          if (np !== pointer || refreshPointer === true) {
            pointer = np
            refreshPointer = false
            data = new Uint8ClampedArray(memory.buffer, pointer, width * height * 4);
            img = new ImageData(data, width, height);
          }
          if (img) {
            ctx.putImageData(img, 0, 0);
          }
          frames++;
          window.requestAnimationFrame(render);
      };
      window.requestAnimationFrame(render);

      window.setInterval(function(){
        const current = new Date().getTime()
        document.getElementById('fps-counter').innerText =
          (frames / (current-frameTime) * 1000).toFixed(1) + " fps";
        frames = 0
        frameTime = current
      }, 2000)
    },
  };
  </script>
  <script src="./main.js"> </script>
</html>